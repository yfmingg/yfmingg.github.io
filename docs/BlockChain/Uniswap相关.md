# Uniswap相关

官网：<https://uniswap.org/>

## Uniswap-V3特性

## 恒定乘积做市模型(CPMM)和滑点(slippage)

Uniswap-v2 使用了恒定乘积做市模型来实现自动化做市商。其计算步骤如下：

1. 甲 提供了 1000 个 TokenA 和 100 个 TokenB 作为流动池，即兑换比例: 10个TokenA = 1个TokenB，计乘数 Kab = 1000 *100 = 100000
2. 乙想要使用 100 个 TokenA 兑换 TokenB，那么 Uniswap-v2 会首先计算交易后流动池会有 1000 + 100 = 1100 个 TokenA；为了维持 Kab 的不变，就需要 TokenB 的数量减少为 100000/1100 = 90.909... 。因此乙兑换出的TokenB = 100 - 90.909 = 9.091 个。低于按兑换比例应得的10个。
3. 当乙使用 1000 个 TokenA 兑换 TokenB时，可以算出兑换出的TokenB = 100 - [100000 / (1000 + 1000)] = 50 个。低于按兑换比例应得的100个TokenB。
4. 根据2和3例，可以预见的是，根据这套算法，乙需要兑换的 TokenA 越多，平均每个 TokenA 能兑换的 TokenB 就会越少。这就产生了滑点的概念。3例的滑点高达50%。

简化公式：(TokenA余额 + 你出售的TokenA)*(TokenB余额 - 你获得的TokenB) = 常数K

## 无偿损失

当你在 Uniswap-v2 上为代币提供流动性，赚取手续费时，会涉及到无常损失的计算。下面举一个简单的例子：

1. 甲在 Uniswap-v2 上提供了 1000 个 TokenA 和 100 个 usdt 作为流动池
2. 乙在 Uniswap-v2 上使用 1000 个 TokenA 兑换了 50 个 usdt，该交易的滑点为50%，池子里剩下 2000 个 TokenA 和 50 个 usdt。
3. 原来甲在 Uniswap-v2 上提供的总资产价值为 1000 个 TokenA 和 100 个 usdt，TokenA 对 usdt 的兑换比率为 1000 ：100，可以换算为 200 个 usdt。
4. 乙兑换之后，甲在 Uniswap-v2 上提供的流动性资产价值为：2000 个 TokenA 和 50 个 usdt，TokenA 对 usdt 的兑换比率为 2000：50 ，总计为 100 个 usdt。

对比上述情形，如果甲本来就不提供流动性，TokenA 对 usdt 的兑换比率跌为2000：50 ，则其资产为 1000 个 TokenA 和 100 个 usdt = 125 usdt。可以看到，甲因为提供流动性多损失了25usdt，这就是资产下跌造成的无常损失。

1. 当乙改为在 Uniswap-v2 上使用 100 个 usdt 兑换了 500 个 TokenA。乙兑换之后，甲在 Uniswap-v2 上提供的流动性资产价值为：500 个 TokenA 和 200 个 usdt，TokenA 对 usdt 的兑换比率为 500：200，总计为 400 个 usdt。

对比上述情形，如果甲本来就不提供流动性，TokenA 对 usdt 的兑换比率涨到500：200，则其资产为 1000 个 TokenA 和 100 个 usdt = 500 usdt。可以看到，甲因为提供流动性少赚了100usdt，这就是资产上涨造成的无常损失。

简单总结：无常损失就是流动性提供者，在资产上涨过程中自动卖出，在资产下跌过程中自动买入所造成的损失。

## 价格预言机

Uniswap-v2 所代表的去中心化交易所，提供去中心化的价格生成体系。以此为基础，可以打造出一个去中心化的价格生成和获取系统。

这对于去中心化的借贷、杠杆等金融衍生品来说非常重要，虽然目前 Uniswap-v2 所代表的去中心化单一流动池价格预言机并不是完全安全的。

## 闪电兑换(Flash Swaps)

与传统贷款不同，在闪电贷中，在一个交易里完成资金借入和归还。这一点是必须的。

在Defi里，交易者（通常通过机器人）不断寻找套利机会，通过在为同一资产提供不同价格的平台之间进行交易来获得利益。这就是闪电贷出现的地方（通常是）。

在闪电贷的帮助下，交易者可以借到一大笔钱来执行套利交易。闪电贷和闪电兑换其实是一回事。
